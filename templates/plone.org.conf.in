# This file is generated by buildout
    upstream backend {${upstream}}

    server {
        listen ${listen};
        server_name ${vhost};
        root ${buildout:directory}/static; 

        location = /nginx-status {
            stub_status on;
            allow 127.0.0.1;
            deny all;
        }

        ${robots-blocker}

        gzip             on;
        gzip_min_length  1000;
        gzip_proxied     any;
	gzip_types	 text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;


        client_max_body_size 10M;

        # increase proxy buffer size to avoid problems with HTMLParser
        proxy_buffers 8 256k;
        proxy_buffer_size 256k;

        # Push this to varnish to avoid problems
        # error_page 500 /500.html;
        location = /500.html {  }

        location ^~ /images/ {
            autoindex on;
        }
        location = /plone.css {  }
        location = /ie.css {  }
        location ~ /emptypage$ {
            rewrite ^/(.*)$ ${virtual-host}/$1 break;
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-XDV "true";
        }
        location /_xdv_disabled/ {
            rewrite ^/_xdv_disabled/(.*)$ ${virtual-host}/$1 break;
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-XDV "true";
        }
        location ~ /(plugins/plone|refbrowser_popup|image_view_fullscreen) {
            rewrite ^/(.*)$ ${virtual-host}/$1 break;
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-XDV "true";
        }
        location / {
            rewrite ^/login_form https://${vhost}/login_form;
            rewrite ^/logged_out https://${vhost}/logged_out;
	    rewrite ^/(.+)/require_login(.*) https://${vhost}/$1/require_login$2;
            rewrite ^/(.*)$ ${virtual-host}/$1 break;
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-XDV "true";
            xslt_stylesheet ${buildout:directory}/etc/default.xsl;
            xslt_html_parser on;
            xslt_types text/html;
        }
        location = / {
            rewrite ^/(.*)$ ${virtual-host}/$1 break;
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-XDV "true";
            xslt_stylesheet ${buildout:directory}/etc/wide.xsl;
            xslt_html_parser on;
            xslt_types text/html;
        }
        location ~ ^/(products(/psc_view_ploneorg)?|documentation|documentation/kb|support|support/support_view)/?$ {
            rewrite ^/(.*)$ ${virtual-host}/$1 break;
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-XDV "true";
            xslt_stylesheet ${buildout:directory}/etc/wide.xsl;
            xslt_html_parser on;
            xslt_types text/html;
        }
        location ~ ^/products/(simple|links|\+\+simple\+\+)/?$ {
            rewrite ^    http://dist.${vhost}/packages permanent;
        }
        location /dist.plone.org {
            internal;
            # autoindex on;
            alias /srv/dist.plone.org/http/root/;
        }
        location ~ ^/products/(.*)/((.*)(tgz|tar.gz|bz2|tar.bz2|zip|tbz|exe))$ {
            rewrite ^/products/(.*)/((.*)(tgz|tar.gz|bz2|tar.bz2|zip|tbz|exe))$ /dist.plone.org/packages/$3$4;
        }
    }

    server {
        listen ${listen};
        server_name manage.${vhost};
        root ${buildout:directory}/static;

        location = /nginx-status {
            stub_status on;
            allow 127.0.0.1;
            deny all;
        }

        gzip             on;
        gzip_min_length  1000;
        gzip_proxied     any;
        gzip_types       text/xml text/plain application/xml;

        location / {
            proxy_pass http://${manage-ip-port}${manage-virtual-host}/;
        }
        location ^~ /images/ {
            autoindex on;
        }
        location ^~ /plone.css {  }
        location ^~ /ie.css {  }
        location ~ /emptypage$ {
            rewrite ^/(.*)$ ${virtual-host}/$1 break;
            proxy_pass http://backend;
        }
    }

    server {
            listen ${listen};
            server_name dist.${vhost};
            root /srv/dist.plone.org/http/root;
            location / {
                    autoindex on;
            }
            access_log ${buildout:directory}/var/log/dist.${vhost}-access.log main;
            error_log ${buildout:directory}/var/log/dist.${vhost}-error.log;
    }

    # plone countries
#    server {
#            listen ${listen};
#            server_name     plone.asia;
#            location / {
#                    rewrite ^/(.*)$ http://${vhost}/$1 last;
#            }
#    }
#
#    server {
#            listen ${listen};
#            server_name     plone.it www.plone.it;
#            location / {
#                    rewrite ^/(.*)$ http://${vhost}/countries/it/$1 last;
#            }
#    }
#
#    server {
#            listen ${listen};
#            server_name     plone.hu www.plone.hu;
#            location / {
#                    rewrite ^/(.*)$ http://${vhost}/countries/hu/$1 last;
#            }
#    }
#
#    server {
#            listen ${listen};
#            server_name     plone.eu www.plone.eu;
#            location / {
#                    rewrite ^/(.*)$ http://${vhost}/countries/mx/$1 last;
#            }
#    }

    server {
            listen ${listen};
            server_name     plone.com.mx www.plone.com.mx plone.org.mx www.plone.org.mx;
            location / {
                    rewrite ^/(.*)$ http://${vhost}/countries/mx/$1 last;
            }
    }
    server {
            listen ${listen};
            server_name     plone.com.ar www.plone.com.ar plone.cl www.plone.cl;
            location / {
                    rewrite ^/(.*)$ http://${vhost}/countries/conosur/$1 last;
            }
    }

    # BBB media.plone.org
    server {
            listen ${listen};
            server_name     media.${vhost};
            rewrite ^(.*) http://dist.${vhost}/media$1 permanent;
            access_log ${buildout:directory}/var/log/dist.${vhost}-access.log main;
            error_log ${buildout:directory}/var/log/dist.${vhost}-error.log;
    }

    # rewrite www.plone.org to plone.org for SEO
    server {
            listen ${listen};
            server_name     www.${vhost};
            location / {
                    rewrite ^/(.*)$ http://${vhost}/$1 last;
            }
    }

    # rewrites to map plone.net requests to new locations in plone.org
    server {
            listen ${listen};
            server_name     plone.net;
            location / {
                rewrite ^/about(.*) http://${vhost}/foundation/donors$1 permanent;
                rewrite ^/providers(.*) http://${vhost}/support/providers$1 permanent;
                rewrite ^/case-studies(.*) http://${vhost}/support/case-studies$1 permanent;
                rewrite ^/buzz(.*) http://${vhost}/news/buzz$1 permanent;
                rewrite ^/sites(.*) http://${vhost}/support/sites$1 permanent;
                rewrite ^/hosting-providers(.*) http://${vhost}/support/hosting-providers$1 permanent;
                # following rule must be last
                rewrite ^ http://${vhost}/support/network permanent;
            }
    }

    # rewrite www.plone.net to plone.net
    server {
            listen ${listen};
            server_name     www.plone.net;
            location / {
                    rewrite ^/(.*)$ http://plone.net/$1 last;
            }
    }

    # rewrites to map plone.in requests to new locations in plone.org
    server {
            listen ${listen};
            server_name     plone.in;
            location / {
                rewrite ^/argentina http://${vhost}/support/sites/sites_listing?countries%3alist=ar permanent;
                rewrite ^/australia http://${vhost}/support/sites/sites_listing?countries%3alist=au permanent;
                rewrite ^/austria http://${vhost}/support/sites/sites_listing?countries%3alist=at permanent;
                rewrite ^/belgium http://${vhost}/support/sites/sites_listing?countries%3alist=be permanent;
                rewrite ^/brazil http://${vhost}/support/sites/sites_listing?countries%3alist=br permanent;
                rewrite ^/bulgaria http://${vhost}/support/sites/sites_listing?countries%3alist=bg permanent;
                rewrite ^/canada http://${vhost}/support/sites/sites_listing?countries%3alist=ca permanent;
                rewrite ^/chile http://${vhost}/support/sites/sites_listing?countries%3alist=cl permanent;
                rewrite ^/china http://${vhost}/support/sites/sites_listing?countries%3alist=cn permanent;
                rewrite ^/costarica http://${vhost}/support/sites/sites_listing?countries%3alist=cr permanent;
                rewrite ^/cuba http://${vhost}/support/sites/sites_listing?countries%3alist=cu permanent;
                rewrite ^/czechia http://${vhost}/support/sites/sites_listing?countries%3alist=cz permanent;
                rewrite ^/denmark http://${vhost}/support/sites/sites_listing?countries%3alist=dk permanent;
                rewrite ^/egypt http://${vhost}/support/sites/sites_listing?countries%3alist=eg permanent;
                rewrite ^/elsalvador http://${vhost}/support/sites/sites_listing?countries%3alist=sv permanent;
                rewrite ^/finland http://${vhost}/support/sites/sites_listing?countries%3alist=fi permanent;
                rewrite ^/france http://${vhost}/support/sites/sites_listing?countries%3alist=fr permanent;
                rewrite ^/germany http://${vhost}/support/sites/sites_listing?countries%3alist=de permanent;
                rewrite ^/greece http://${vhost}/support/sites/sites_listing?countries%3alist=gr permanent;
                rewrite ^/greenland http://${vhost}/support/sites/sites_listing?countries%3alist=gl permanent;
                rewrite ^/hongkong http://${vhost}/support/sites/sites_listing?countries%3alist=hk permanent;
                rewrite ^/hungary http://${vhost}/support/sites/sites_listing?countries%3alist=hu permanent;
                rewrite ^/iceland http://${vhost}/support/sites/sites_listing?countries%3alist=is permanent;
                rewrite ^/india http://${vhost}/support/sites/sites_listing?countries%3alist=in permanent;
                rewrite ^/ireland http://${vhost}/support/sites/sites_listing?countries%3alist=ie permanent;
                rewrite ^/italy http://${vhost}/support/sites/sites_listing?countries%3alist=it permanent;
                rewrite ^/japan http://${vhost}/support/sites/sites_listing?countries%3alist=jp permanent;
                rewrite ^/kazakhstan http://${vhost}/support/sites/sites_listing?countries%3alist=kz permanent;
                rewrite ^/korea http://${vhost}/support/sites/sites_listing?countries%3alist=kr permanent;
                rewrite ^/latvia http://${vhost}/support/sites/sites_listing?countries%3alist=lv permanent;
                rewrite ^/lithuania http://${vhost}/support/sites/sites_listing?countries%3alist=lt permanent;
                rewrite ^/malta http://${vhost}/support/sites/sites_listing?countries%3alist=mt permanent;
                rewrite ^/mexico http://${vhost}/support/sites/sites_listing?countries%3alist=mx permanent;
                rewrite ^/monaco http://${vhost}/support/sites/sites_listing?countries%3alist=mc permanent;
                rewrite ^/mozambique http://${vhost}/support/sites/sites_listing?countries%3alist=mz permanent;
                rewrite ^/netherlands http://${vhost}/support/sites/sites_listing?countries%3alist=nl permanent;
                rewrite ^/newzealand http://${vhost}/support/sites/sites_listing?countries%3alist=nz permanent;
                rewrite ^/nigeria http://${vhost}/support/sites/sites_listing?countries%3alist=ng permanent;
                rewrite ^/norway http://${vhost}/support/sites/sites_listing?countries%3alist=no permanent;
                rewrite ^/philippines http://${vhost}/support/sites/sites_listing?countries%3alist=ph permanent;
                rewrite ^/poland http://${vhost}/support/sites/sites_listing?countries%3alist=pl permanent;
                rewrite ^/portugal http://${vhost}/support/sites/sites_listing?countries%3alist=pt permanent;
                rewrite ^/reunion http://${vhost}/support/sites/sites_listing?countries%3alist=re permanent;
                rewrite ^/romania http://${vhost}/support/sites/sites_listing?countries%3alist=ro permanent;
                rewrite ^/russia http://${vhost}/support/sites/sites_listing?countries%3alist=ru permanent;
                rewrite ^/slovenia http://${vhost}/support/sites/sites_listing?countries%3alist=si permanent;
                rewrite ^/southafrica http://${vhost}/support/sites/sites_listing?countries%3alist=za permanent;
                rewrite ^/spain http://${vhost}/support/sites/sites_listing?countries%3alist=es permanent;
                rewrite ^/sweden http://${vhost}/support/sites/sites_listing?countries%3alist=se permanent;
                rewrite ^/switzerland http://${vhost}/support/sites/sites_listing?countries%3alist=ch permanent;
                rewrite ^/thailand http://${vhost}/support/sites/sites_listing?countries%3alist=th permanent;
                rewrite ^/uganda http://${vhost}/support/sites/sites_listing?countries%3alist=ug permanent;
                rewrite ^/ukraine http://${vhost}/support/sites/sites_listing?countries%3alist=ua permanent;
                rewrite ^/unitedarabemirates http://${vhost}/support/sites/sites_listing?countries%3alist=ae permanent;
                rewrite ^/uk http://${vhost}/support/sites/sites_listing?countries%3alist=gb permanent;
                rewrite ^/us http://${vhost}/support/sites/sites_listing?countries%3alist=us permanent;
                rewrite ^/venezuela http://${vhost}/support/sites/sites_listing?countries%3alist=ve permanent;
                rewrite ^/(..)$ http://${vhost}/support/sites/sites_listing?countries%3alist=$1 permanent;
                rewrite ^ http://${vhost}/support/sites/ permanent;
             }


    }

    # rewrite www.plone.in to plone.in
    server {
            listen ${listen};
            server_name     www.plone.in;
            location / {
                    rewrite ^/(.*)$ http://plone.in/$1 last;
            }
    }

    server {
            listen ${listen};
            server_name    newplone.sixfeetup.com;
            location / {
                      rewrite ^/(.*)$ http://plone.org/$1 last;
            }
     }

     # http://plone.293351.n2.nabble.com/Fail-to-install-Plone-with-plone-recipe-plone-3-1-7-td5730780.html
     server {
            listen 5021;
            server_name antiloop.plone.org;
            root /srv/dist.plone.org/http/root;
            location / {
                    autoindex on;
            }
            access_log /srv/plone.org/var/log/antiloop.plone.org-access.log main;
            error_log /srv/plone.org/var/log/antiloop.plone.org-error.log;
     }
